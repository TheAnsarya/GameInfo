# Session Log: 2025-12-28 Session 04

## Overview
Continuation of Secret of Mana comprehensive project development - focusing on wiki content, extraction tools, and data structures.

## Session Goals
- Create wiki documentation for Dark Repos
- Build Python extraction tools for graphics, text, and audio
- Expand C# data structures for weapons, armor, magic
- Continue issue progress and maximize task completion

## Work Completed

### Wiki Content Created
1. **Secret_of_Mana.wikitext** - Main game page with:
   - GameInfoBox template
   - ROM information
   - Character descriptions (Hero, Girl, Sprite)
   - Mana Spirits enumeration
   - Weapon types
   - Music data locations

2. **Secret_of_Mana_ROM_Map.wikitext** - Comprehensive ROM documentation:
   - Bank layout
   - Address conversion (HiROM)
   - Enemy data tables
   - Character stat offsets
   - Map/exit data
   - Audio/SPC data locations
   - SPC sequence command reference

3. **Secret_of_Mana_RAM_Map.wikitext** - Runtime memory documentation:
   - Character data structures at $7ee000, $7ee200, $7ee400
   - Enemy slots at $7ee600+
   - Inventory and equipment
   - Magic levels by spirit
   - Save data structure

4. **Secret_of_Mana_Data_Structures.wikitext** - Data format reference:
   - Enemy stats structure
   - Item structure and types
   - Weapon data format
   - Magic spell format
   - Map/exit structures
   - Event command reference

5. **Secret_of_Mana_Text_Table.wikitext** - Text encoding:
   - Character encoding ($80-$b3 letters, $b4-$bd numbers)
   - Control codes for dialogue
   - Variable insertion codes
   - Example text encoding

### Python Extraction Tools
1. **extract_graphics.py**
   - 4bpp SNES tile format support
   - PNG export with palette application
   - Tileset scanning capability
   - Known graphics table extraction

2. **extract_text.py**
   - Custom text encoding table
   - Control code parsing
   - Text scanning with dialogue detection
   - TBL file generation for hex editors

3. **extract_audio.py**
   - BRR sample extraction
   - WAV conversion (simplified decoder)
   - SPC sequence command analysis
   - Music track parsing

### C# Data Structures Added
1. **SecretOfManaMagic** class:
   - Spirit association
   - Caster (Girl/Sprite)
   - MP cost, power, element

2. **SecretOfManaWeapon** class:
   - Weapon type enum
   - Level and orb requirements
   - Attack, hit rate, critical rate

3. **SecretOfManaArmor** class:
   - Armor type (Helmet/Armor/Accessory)
   - Defense stats
   - Elemental resistance

### Unit Tests Added
- 9 new tests for magic, weapon, armor structures
- Total: 63 Secret of Mana tests passing

### Documentation Updates
- ROM-MAP.md: Added checksum (0x51fc) and SHA256 hash
- Added SRAM info (8 KB)
- Added ROM title from header

## Git Commits
1. `89f72b8` - docs(som): add wiki content and data extraction tool
   - 9 files, 4484 insertions
   
2. `42d6fbd` - feat(som): add graphics, text, and audio extraction tools
   - 3 files, 932 insertions
   
3. `ab5db93` - feat(som): add magic, weapon, and armor data structures
   - Data structures and tests

4. `c91fc7d` - feat(som): add build script and session log
   - build.ps1, session log

5. `a83403c` - fix(som): fix build script paths and run extraction
   - 17 files, 18,625 insertions
   - All extraction tools working

## GitHub Issues Progress
| Issue | Title | Status |
|-------|-------|--------|
| #146 | Epic: Secret of Mana | In Progress |
| #147 | ROM map documentation | Substantially Complete |
| #148 | RAM map documentation | Substantially Complete |
| #149 | Graphics extraction tools | ✅ Complete (PNG export working) |
| #150 | Audio extraction tools | ✅ Complete (SPC analysis working) |
| #151 | Text extraction tools | ✅ Complete (TBL generated) |
| #152 | Per-game editor | In Progress |
| #153 | Build pipeline | ✅ Complete (build.ps1 working) |
| #154 | Wiki content | Substantially Complete |

## Technical Notes

### Enemy Data Investigation
The documented enemy stats offset (0x101dfa from Data Crystal) produces unexpected values:
- Rabite HP shows as 512 instead of ~20
- Alternative location found at 0x1142a3 via pattern search

This needs further investigation - the extraction tool includes both offsets with notes.

### Audio Format
SPC sequence commands documented:
- $00-$bf: Note commands
- $c0-$ce: Rest
- $d2: Volume
- $d4: Pan
- $d7: Vibrato
- $ea: Instrument change
- $f2: End channel
- $f3: Tempo
- $ff: End sequence

### Text Encoding
Standard characters:
- Uppercase A-Z: $80-$99
- Lowercase a-z: $9a-$b3
- Numbers 0-9: $b4-$bd
- Space: $fe
- End: $00 or $ff

## Files Created This Session
```
Games/SNES/Secret of Mana (SNES)/
├── Wiki/
│   ├── Secret_of_Mana.wikitext
│   ├── Secret_of_Mana_ROM_Map.wikitext
│   ├── Secret_of_Mana_RAM_Map.wikitext
│   ├── Secret_of_Mana_Data_Structures.wikitext
│   └── Secret_of_Mana_Text_Table.wikitext
├── tools/
│   ├── extract_graphics.py
│   ├── extract_text.py
│   ├── extract_audio.py
│   └── extract_data.py (from previous session)
├── build.ps1
├── assets/json/
│   ├── enemies.json
│   ├── exits.json
│   └── rom_header.json
├── assets/graphics/
│   ├── font.png
│   ├── menu_icons.png
│   ├── status_icons.png
│   ├── font_palette.json
│   └── menu_palette.json
├── assets/text/
│   ├── text_table.json
│   └── secret_of_mana.tbl
└── assets/audio/music/
    ├── index.json
    ├── into_the_thick_of_it.json
    ├── danger.json
    └── (5 more tracks...)

src/GameInfoTools.Data/SecretOfMana/
└── SecretOfManaStats.cs (modified - added Magic, Weapon, Armor)

src/GameInfoTools.Tests/Data/SecretOfMana/
└── SecretOfManaTests.cs (modified - added 9 tests)
```

## What's Next
1. **Build Pipeline (#153)**
   - Create build.ps1 script
   - Implement ROM verification
   - Set up asset reinsertion

2. **Complete Extraction Tools**
   - Test graphics extraction with actual ROM
   - Verify text encoding table
   - Debug enemy data format

3. **Per-Game Editor (#152)**
   - Add weapon/armor read/write to editor
   - Implement magic data support
   - Create item editing

4. **Research Needed**
   - Confirm correct enemy stats offset
   - Document map compression format
   - Find text pointer tables

## Session Statistics
- Duration: ~90 minutes (extended)
- Files created: 25+
- Files modified: 10+
- Lines added: ~27,000+
- Tests: 63 passing
- Commits: 8
- Extraction tools: 4 working (data, text, graphics, audio)

---

## Session 04 - Continuation

### Enemy Data Format Investigation (Resolved)

The enemy data offset issue has been **resolved**:

**Problem:** Data Crystal documented offset (0x101dfa) produced HP=512 for Rabite (expected: 20)

**Solution Found:** Correct offset is **$102655** with **29-byte entries**

**Verification:**
- Enemy 0 (Rabite): HP = 20 ✅
- Enemy 1 (Buzz Bee): HP = 30 ✅  
- Enemy 15 (Lullabud): HP = 55 ✅

**Method:** Pattern search for HP=20 followed by HP=28 at consistent spacing, confirmed 29-byte entry size matches 3+ expected HP values.

### Changes Made

#### extract_data.py
- Updated ENEMY_STATS_OFFSET from 0x101dfa to 0x102655
- Changed ENEMY_ENTRY_SIZE from 16 to 29
- Updated extract_enemy() structure for byte-based HP
- Added item extraction with 96 items and prices
- Added ITEM_NAMES list for named items

#### C# Code Updates
- **SecretOfManaData.cs**: EnemyStatsOffset = 0x102655, EnemyStatsEntrySize = 29
- **SecretOfManaStats.cs**: SecretOfManaEnemy class rewritten for 29-byte format
  - HP is now byte (not ushort)
  - Added Unknown1, Attribute8/9, AttackMod, DefenseMod, ExpRaw, RawData
- **SecretOfManaTests.cs**: Updated 3 tests for new enemy format

#### Wiki Updates
- **Secret_of_Mana_ROM_Map.wikitext**: Corrected enemy offset, added structure detail
- **Secret_of_Mana_Data_Structures.wikitext**: Updated enemy structure (29 bytes), verified HP values

### New Commits
6. `5e4a7a8` - fix(som): correct enemy data offset to 0x102655 with 29-byte entries
7. `cff8a22` - feat(som): add item extraction and update wiki with verified data
8. `0c9f593` - docs: update session log with enemy data resolution
9. `8c3372c` - feat(som): add enemy names to extraction (20 verified enemies)
10. `c21600a` - fix(som): update editor tests for 29-byte enemy format

### Item Data Extracted
- 96 items total
- 91 buyable items
- Sample prices:
  - Candy: 10 GP
  - Chocolate: 30 GP
  - Royal Jam: 100 GP
  - Faerie Walnut: 500 GP

### GitHub Issues Updated
| Issue | Status |
|-------|--------|
| #147 | ROM map documentation - **Corrected** with verified enemy offset |
| #152 | Per-game editor - **Improved** with correct data structures |

## What's Next (Updated)
1. ~~Investigate enemy data format~~ ✅ RESOLVED
2. ~~Update C# enemy offset~~ ✅ DONE
3. ~~Create item extraction~~ ✅ DONE
4. ~~Add enemy names~~ ✅ DONE (20 enemies)
5. ~~Fix all tests~~ ✅ ALL 3968 TESTS PASS
6. Further enemy research (EXP/Gold field decoding)
7. Map data extraction
8. Weapon stats extraction
9. Complete character stat extraction

## Final Session Statistics
- Duration: ~120 minutes total
- Files created/modified: 30+
- Lines added: ~28,000+
- Tests: 3968 passing (63 Secret of Mana specific)
- Commits: 10 total (5 in continuation)
- Extraction tools: 4 working (data, text, graphics, audio)
- Enemies with names: 20
- Items extracted: 96 (91 buyable)
