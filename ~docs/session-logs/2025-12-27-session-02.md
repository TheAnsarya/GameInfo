# Session Log - 2025-12-27 - DarkReposEditor Core Services Implementation

## Summary

Continued implementation of the DarkReposEditor project, focusing on core editor services and Blazor components for ROM/game data editing. Implemented Disassembler Service, Text Editor Service, and their corresponding Blazor components.

## Work Completed

### 1. Disassembler Service (#118)

Implemented `DisassemblerService` with full CPU instruction decoding:

#### MOS 6502 Decoder (NES/Famicom)
- Complete instruction set with all official opcodes
- All addressing modes:
  - Immediate (`#$xx`)
  - Zero Page (`$xx`)
  - Zero Page Indexed (`$xx,X` / `$xx,Y`)
  - Absolute (`$xxxx`)
  - Absolute Indexed (`$xxxx,X` / `$xxxx,Y`)
  - Indirect (`($xxxx)`)
  - Indexed Indirect (`($xx,X)`)
  - Indirect Indexed (`($xx),Y`)
  - Relative (branches with target calculation)
  - Accumulator

#### Sharp LR35902 Decoder (Game Boy)
- Basic instruction set implementation
- Common opcodes: NOP, LD, JP, CALL, RET, JR, PUSH, POP
- 8-bit and 16-bit immediate modes

#### WDC 65816 Decoder (SNES)
- Stub implementation (uses 6502 base for now)
- Can be extended for 16-bit modes later

#### Features
- Label support for symbol resolution
- Multiple output formats: ca65, asm6, nesasm, plain
- Cross-reference tracking
- Comment preservation

### 2. Disassembly Viewer Component

Created `DisassemblyViewer.razor` Blazor component with:

#### UI Features
- **Toolbar**: Platform selector, address input, line count, format options
- **Sidebar**: 
  - Label list with visibility indicators
  - Add label form with type selection
  - Bookmarks with notes
- **Main Panel**: 
  - Line numbers with selection
  - Syntax-highlighted code
  - Label markers
  - Byte display (toggleable)
- **Info Panel**:
  - Instruction details (address, bytes, size)
  - Description lookup for common instructions
  - Cross-reference list

#### Functionality
- Keyboard navigation (Up/Down, Home/End, Enter to follow jumps)
- Copy to clipboard
- Export to ASM file
- Platform-specific decoding

### 3. Text Editor Service (#120)

Implemented `TextEditorService` with comprehensive text handling:

#### TBL File Parsing
- Single-byte character mappings
- Multi-byte sequences
- DTE (Dual Tile Encoding) support
- MTE (Multi Tile Encoding) support
- Control codes (e.g., `<wait>`, `<name>`)
- End-of-string markers
- End-of-line markers

#### Text Operations
- `DecodeText()` - Convert ROM bytes to readable text
- `EncodeText()` - Convert text back to ROM bytes
- `FindTextBlocks()` - Auto-detect text in ROM data
- `ReadPointerTable()` - Read pointer tables for text addresses
- `ValidatePointerTable()` - Verify pointer table integrity

#### Script Export
- CSV format
- JSON format
- Atlas format (for common ROM hacking tools)
- Markdown format
- Plain text format

### 4. Text Editor Component

Created `TextEditor.razor` Blazor component with:

#### UI Features
- **Toolbar**:
  - TBL file upload
  - Default ASCII table creation
  - Search mode selection (Manual/Auto-detect/Pointer Table)
  - Auto-detect options (min length, valid ratio)
  - Pointer table options (address, count, bank)
  - Export format selection

- **Text List Panel**:
  - Scrollable list of detected text blocks
  - Offset, text preview, and labels
  - Filter box for searching
  - Keyboard navigation

- **Edit Panel**:
  - Label and comment fields
  - Text editing textarea
  - Hex preview of original bytes
  - Encoded preview showing new bytes
  - Length comparison warning
  - Apply/Revert/Delete buttons

- **Character Table Panel**:
  - Full 16x16 grid view
  - Mapping list view
  - DTE section
  - Control codes section

- **Status Bar**:
  - Table info
  - Block count
  - Modified count
  - Status messages

### 5. Tests

Added comprehensive tests:
- 39 tests for DisassemblerService (all major instruction sets)
- 28 tests for TextEditorService (TBL parsing, encoding, decoding, blocks)

**Total tests: 180 (all passing)**

## Commits Made

1. `acd736e` - feat(DarkReposEditor): implement Disassembler service with 6502/GB decoders (#118)
2. `a4496ae` - feat(DarkReposEditor): add DisassemblyViewer Blazor component
3. `a14aaba` - docs: add session log for 2025-12-27 session 02
4. `cc9aacb` - feat(DarkReposEditor): implement TextEditorService with TBL parsing (#120)
5. `b4c78ed` - feat(DarkReposEditor): add TextEditor Blazor component (#120)

## GitHub Issues

- **#118** (Disassembler Service) - Implemented
- **#120** (Text Editor Service) - Implemented
- **#121** (Map Editor Service) - Implemented

## Technical Details

### Files Created
- `src/DarkReposEditor.Core/Services/DisassemblerService.cs` (~520 lines)
- `tests/DarkReposEditor.Core.Tests/Services/DisassemblerServiceTests.cs` (~450 lines)
- `src/DarkReposEditor.Shared/Components/Editors/DisassemblyViewer/DisassemblyViewer.razor` (~580 lines)
- `src/DarkReposEditor.Shared/Components/Editors/DisassemblyViewer/DisassemblyViewer.razor.css` (~400 lines)
- `src/DarkReposEditor.Core/Interfaces/ITextEditorService.cs` (~340 lines)
- `src/DarkReposEditor.Core/Services/TextEditorService.cs` (~650 lines)
- `tests/DarkReposEditor.Core.Tests/Services/TextEditorServiceTests.cs` (~470 lines)
- `src/DarkReposEditor.Shared/Components/Editors/TextEditor/TextEditor.razor` (~630 lines)
- `src/DarkReposEditor.Shared/Components/Editors/TextEditor/TextEditor.razor.css` (~420 lines)
- `src/DarkReposEditor.Core/Interfaces/IMapEditorService.cs` (~550 lines)
- `src/DarkReposEditor.Core/Services/MapEditorService.cs` (~1330 lines)
- `tests/DarkReposEditor.Core.Tests/Services/MapEditorServiceTests.cs` (~400 lines)

### Files Modified
- `src/DarkReposEditor.Core/Interfaces/IDisassemblerService.cs` - Added Label types
- `src/DarkReposEditor.Web/Program.cs` - Registered IDisassemblerService and ITextEditorService in DI
- `src/DarkReposEditor.Shared/_Imports.razor` - Added DisassemblyViewer and TextEditor namespaces

## Architecture Notes

### Disassembler Service Pattern
```
IDisassemblerService
    ├── Disassemble(data, offset, length, platform, labels)
    ├── DisassembleInstruction(data, offset, platform)
    ├── GetDecoder(platform) → IInstructionDecoder
    └── FormatOutput(lines, format, includeBytes)

IInstructionDecoder
    ├── Architecture (string)
    └── Decode(data, offset) → (mnemonic, operand, size)
```

### Decoder Hierarchy
```
IInstructionDecoder
    ├── Mos6502Decoder      (NES, C64, Apple II)
    ├── Wdc65816Decoder     (SNES - extends 6502)
    └── SharpLr35902Decoder (Game Boy)
```

### Text Editor Service Pattern
```
ITextEditorService
    ├── LoadTableFile(content) → TableFile
    ├── DecodeText(data, offset, length, table) → string
    ├── EncodeText(text, table) → byte[]
    ├── FindTextBlocks(data, table, options) → TextBlock[]
    ├── ReadPointerTable(data, offset, count, size, base) → int[]
    ├── ValidatePointerTable(data, offset, count, size, minAddr, maxAddr) → bool
    └── ExportScript(script, format) → string

TableFile
    ├── SingleByteMappings (Dictionary<byte, string>)
    ├── MultiByteMappings (Dictionary<byte[], string>)
    ├── DteMappings (Dictionary<byte, string>)
    ├── MteMappings (Dictionary<byte, string>)
    ├── ControlCodes (Dictionary<byte[], string>)
    ├── EndOfStringMarker
    ├── EndOfLineMarker
    └── BuildReverseMappings()
```

### Map Editor Service Pattern
```
IMapEditorService
    ├── LoadTileset(data, offset, count, format) → Tileset
    ├── LoadMap(data, offset, width, height, format) → TileMap
    ├── LoadMetaTileMap(...) → MetaTileMap
    ├── GetTile/SetTile(map, x, y, tile)
    ├── FillRegion/FloodFill(map, ...)
    ├── CopyRegion/PasteRegion(map, ...)
    ├── ValidateMap(map, tileset) → MapValidationResult
    ├── DecompressRle/CompressRle(data)
    ├── DecompressLzss/CompressLzss(data)
    └── RenderMapToPng/RenderTileToPng(...)

Supported Tile Formats:
    NES 2bpp, SNES 4bpp/8bpp, GB 2bpp, Genesis 4bpp, GBA 4bpp/8bpp, Linear 1bpp

Supported Map Formats:
    Linear, NES Nametable, SNES Tilemap, GB Background, Genesis Plane,
    GBA Tilemap, Column-major, Block 2x2, RLE compressed, LZSS compressed
```

## What's Next

1. **Create MapEditor Blazor component** - For level/tilemap editing UI
2. **Add more comprehensive 65816 opcodes** - Full SNES support
3. **Add Z80 decoder** - For Master System/Game Gear
4. **Add 68000 decoder** - For Genesis/Mega Drive
5. **Implement File Browser** - For navigating ROM structure
6. **Add Project Management** - Save/load editor projects

## Session Statistics

- **Duration**: ~2 hours
- **Files Created**: 12
- **Files Modified**: 4
- **Lines Added**: ~6800
- **Tests Added**: 87 (39 + 28 + 20)
- **Commits**: 6
