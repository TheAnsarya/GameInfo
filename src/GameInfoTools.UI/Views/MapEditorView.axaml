<UserControl xmlns="https://github.com/avaloniaui"
			 xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
			 xmlns:vm="using:GameInfoTools.UI.ViewModels"
			 xmlns:controls="using:GameInfoTools.UI.Controls"
			 xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
			 xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
			 mc:Ignorable="d" d:DesignWidth="1000" d:DesignHeight="700"
			 x:Class="GameInfoTools.UI.Views.MapEditorView"
			 x:DataType="vm:MapEditorViewModel">

	<Design.DataContext>
		<vm:MapEditorViewModel/>
	</Design.DataContext>

	<Grid RowDefinitions="Auto,Auto,*,Auto">
		<!-- Top Toolbar -->
		<StackPanel Grid.Row="0" Orientation="Horizontal" Spacing="8" Margin="16,16,16,4">
			<TextBlock Text="Offset:" VerticalAlignment="Center"/>
			<NumericUpDown Value="{Binding MapDataOffset}" Minimum="0" Maximum="16777215" Width="100" FormatString="X6"/>
			<TextBlock Text="Width:" VerticalAlignment="Center"/>
			<NumericUpDown Value="{Binding MapWidth}" Minimum="1" Maximum="256" Width="70"/>
			<TextBlock Text="Height:" VerticalAlignment="Center"/>
			<NumericUpDown Value="{Binding MapHeight}" Minimum="1" Maximum="256" Width="70"/>
			<Separator/>
			<Button Content="Load" Command="{Binding LoadMapCommand}" ToolTip.Tip="Load map from ROM"/>
			<Separator/>
			<TextBlock Text="Zoom:" VerticalAlignment="Center"/>
			<Button Content="-" Command="{Binding ZoomOutCommand}" Width="30"/>
			<TextBlock Text="{Binding Zoom, StringFormat={}{0}x}" VerticalAlignment="Center" Width="30" TextAlignment="Center"/>
			<Button Content="+" Command="{Binding ZoomInCommand}" Width="30"/>
			<Separator/>
			<Button Content="Undo" Command="{Binding UndoCommand}" IsEnabled="{Binding CanUndo}" ToolTip.Tip="{Binding UndoDescription}"/>
			<Button Content="Redo" Command="{Binding RedoCommand}" IsEnabled="{Binding CanRedo}" ToolTip.Tip="{Binding RedoDescription}"/>
		</StackPanel>

		<!-- Drawing Tools Toolbar -->
		<Border Grid.Row="1" Background="{DynamicResource SystemControlBackgroundChromeMediumLowBrush}"
				Margin="16,4" Padding="8" CornerRadius="4">
			<StackPanel Orientation="Horizontal" Spacing="8">
				<TextBlock Text="Tools:" VerticalAlignment="Center" FontWeight="SemiBold"/>
				<ToggleButton Content="âœï¸" IsChecked="{Binding CurrentTool, Converter={x:Static vm:EnumConverters.MapToolPencil}}"
							  ToolTip.Tip="Pencil - Draw single tiles" Width="32"/>
				<ToggleButton Content="ðŸª£" IsChecked="{Binding CurrentTool, Converter={x:Static vm:EnumConverters.MapToolFill}}"
							  ToolTip.Tip="Fill - Flood fill area" Width="32"/>
				<ToggleButton Content="â–­" IsChecked="{Binding CurrentTool, Converter={x:Static vm:EnumConverters.MapToolRectangle}}"
							  ToolTip.Tip="Rectangle - Draw filled rectangle" Width="32"/>
				<ToggleButton Content="â•±" IsChecked="{Binding CurrentTool, Converter={x:Static vm:EnumConverters.MapToolLine}}"
							  ToolTip.Tip="Line - Draw line" Width="32"/>
				<ToggleButton Content="â¬š" IsChecked="{Binding CurrentTool, Converter={x:Static vm:EnumConverters.MapToolSelection}}"
							  ToolTip.Tip="Selection - Select region" Width="32"/>
				<ToggleButton Content="ðŸ’‰" IsChecked="{Binding CurrentTool, Converter={x:Static vm:EnumConverters.MapToolEyedropper}}"
							  ToolTip.Tip="Eyedropper - Pick tile" Width="32"/>
				<Separator/>
				<CheckBox Content="Continuous" IsChecked="{Binding ContinuousDraw}" VerticalAlignment="Center"
						  ToolTip.Tip="Draw while dragging"/>
				<Separator/>
				<CheckBox Content="Grid" IsChecked="{Binding ShowGrid}" VerticalAlignment="Center"/>
				<CheckBox Content="Numbers" IsChecked="{Binding ShowTileNumbers}" VerticalAlignment="Center"/>
				<CheckBox Content="16Ã—16 Grid" IsChecked="{Binding ShowMetatileGrid}" VerticalAlignment="Center"
						  ToolTip.Tip="Show metatile grid overlay"/>
				<CheckBox Content="Layers" IsChecked="{Binding ShowLayersPanel}" VerticalAlignment="Center"
						  ToolTip.Tip="Show layers panel"/>
				<Separator/>
				<Button Content="Copy" Command="{Binding CopySelectionCommand}" ToolTip.Tip="Copy selection (Ctrl+C)"/>
				<Button Content="Paste" Command="{Binding PasteSelectionCommand}" IsEnabled="{Binding HasClipboard}"
						ToolTip.Tip="Paste clipboard (Ctrl+V)"/>
				<Button Content="Fill Sel." Command="{Binding FillSelectionCommand}" ToolTip.Tip="Fill selection with selected tile"/>
				<Separator/>
				<Button Content="Export..." Command="{Binding ExportMapCommand}" CommandParameter="{Binding $parent[Window]}"
						ToolTip.Tip="Export map to JSON"/>
				<Button Content="Export PNG..." Command="{Binding ExportMapAsPngCommand}" CommandParameter="{Binding $parent[Window]}"
						ToolTip.Tip="Export map as PNG image"/>
				<Button Content="Import PNG..." Command="{Binding ImportFromPngCommand}" CommandParameter="{Binding $parent[Window]}"
						ToolTip.Tip="Import map from PNG image"/>
				<Separator/>
				<Button Content="ðŸ“‹ Wiki" Command="{Binding CopyAsWikitextCommand}"
						ToolTip.Tip="Copy map data as wikitext"/>
				<Separator/>
				<Button Content="â†‘" Command="{Binding ShiftMapCommand}" CommandParameter="UP" Width="24" ToolTip.Tip="Shift Up"/>
				<Button Content="â†“" Command="{Binding ShiftMapCommand}" CommandParameter="DOWN" Width="24" ToolTip.Tip="Shift Down"/>
				<Button Content="â†" Command="{Binding ShiftMapCommand}" CommandParameter="LEFT" Width="24" ToolTip.Tip="Shift Left"/>
				<Button Content="â†’" Command="{Binding ShiftMapCommand}" CommandParameter="RIGHT" Width="24" ToolTip.Tip="Shift Right"/>
			</StackPanel>
		</Border>

		<!-- Main Content -->
		<Grid Grid.Row="2" ColumnDefinitions="180,*,240" Margin="16,8">
			<!-- Left Panel: Layers -->
			<Border Grid.Column="0" Background="{DynamicResource SystemControlBackgroundChromeMediumBrush}"
					CornerRadius="4" Padding="8" Margin="0,0,8,0"
					IsVisible="{Binding ShowLayersPanel}">
				<DockPanel>
					<TextBlock DockPanel.Dock="Top" Text="ðŸ“š Layers" FontWeight="SemiBold" Margin="0,0,0,8"/>
					<StackPanel DockPanel.Dock="Bottom" Orientation="Horizontal" Spacing="4" Margin="0,8,0,0">
						<Button Content="âž•" Command="{Binding AddLayerCommand}" ToolTip.Tip="Add Layer" Width="28"/>
						<Button Content="ðŸ—‘ï¸" Command="{Binding RemoveLayerCommand}" CommandParameter="{Binding ActiveLayerIndex}"
								ToolTip.Tip="Remove Layer" Width="28"/>
						<Button Content="â¬†ï¸" Command="{Binding MoveLayerUpCommand}" CommandParameter="{Binding ActiveLayerIndex}"
								ToolTip.Tip="Move Up" Width="28"/>
						<Button Content="â¬‡ï¸" Command="{Binding MoveLayerDownCommand}" CommandParameter="{Binding ActiveLayerIndex}"
								ToolTip.Tip="Move Down" Width="28"/>
					</StackPanel>
					<ListBox ItemsSource="{Binding Layers}" SelectedIndex="{Binding ActiveLayerIndex}">
						<ListBox.ItemTemplate>
							<DataTemplate>
								<Grid ColumnDefinitions="Auto,*,Auto">
									<CheckBox Grid.Column="0" IsChecked="{Binding IsVisible}"
											  ToolTip.Tip="Toggle Visibility" Margin="0,0,4,0"/>
									<TextBlock Grid.Column="1" Text="{Binding Name}" VerticalAlignment="Center"/>
									<TextBlock Grid.Column="2" Text="{Binding DataOffset, StringFormat=0x{0:X4}}"
											   FontFamily="Consolas" FontSize="10" Opacity="0.7"
											   VerticalAlignment="Center"/>
								</Grid>
							</DataTemplate>
						</ListBox.ItemTemplate>
					</ListBox>
				</DockPanel>
			</Border>

			<!-- Map View -->
			<Border Grid.Column="1" Background="{DynamicResource SystemControlBackgroundChromeMediumBrush}"
					CornerRadius="4" Padding="8" Margin="0,0,8,0">
				<DockPanel>
					<StackPanel DockPanel.Dock="Top" Orientation="Horizontal" Spacing="8" Margin="0,0,0,8">
						<TextBlock Text="{Binding MapName, FallbackValue=Map View}" FontWeight="SemiBold"/>
						<Button Content="â—€" Command="{Binding PreviousMapCommand}" ToolTip.Tip="Previous Map"/>
						<TextBlock Text="{Binding MapIndex, StringFormat=Map {0}}" VerticalAlignment="Center"/>
						<Button Content="â–¶" Command="{Binding NextMapCommand}" ToolTip.Tip="Next Map"/>
					</StackPanel>
					<ScrollViewer HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Auto">
						<controls:MapCanvas
							x:Name="MapCanvasControl"
							MapData="{Binding MapDataArray}"
							MapWidth="{Binding MapWidth}"
							MapHeight="{Binding MapHeight}"
							TileSize="{Binding Zoom, Converter={x:Static controls:MapCanvas.ZoomToTileSizeConverter}}"
							ShowGrid="{Binding ShowGrid}"
							ShowTileNumbers="{Binding ShowTileNumbers}"
							SelectedX="{Binding SelectedX, Mode=TwoWay}"
							SelectedY="{Binding SelectedY, Mode=TwoWay}"
							SelectionStartX="{Binding SelectionStartX, Mode=TwoWay}"
							SelectionStartY="{Binding SelectionStartY, Mode=TwoWay}"
							SelectionEndX="{Binding SelectionEndX, Mode=TwoWay}"
							SelectionEndY="{Binding SelectionEndY, Mode=TwoWay}"
							ShowMetatileGrid="{Binding ShowMetatileGrid}"/>
					</ScrollViewer>
				</DockPanel>
			</Border>

			<!-- Right Panel: Tile Palette and Settings -->
			<Border Grid.Column="2" Background="{DynamicResource SystemControlBackgroundChromeMediumBrush}"
					CornerRadius="4" Padding="16">
				<ScrollViewer>
					<StackPanel Spacing="12">
						<TextBlock Text="Map Settings" FontWeight="SemiBold" FontSize="16"/>

						<StackPanel Spacing="4">
							<TextBlock Text="Format:"/>
							<ComboBox ItemsSource="{Binding MapFormats}" SelectedItem="{Binding SelectedFormat}"/>
						</StackPanel>

						<!-- DQ Game Presets -->
						<StackPanel Spacing="4">
							<TextBlock Text="ðŸ‰ DQ Presets:"/>
							<ComboBox ItemsSource="{Binding DQPresets}"
									  SelectedItem="{Binding SelectedDQPreset}"
									  PlaceholderText="Select a preset...">
								<ComboBox.ItemTemplate>
									<DataTemplate DataType="vm:GameMapPreset">
										<TextBlock Text="{Binding Name}"/>
									</DataTemplate>
								</ComboBox.ItemTemplate>
							</ComboBox>
							<Button Content="Apply Preset"
									Command="{Binding ApplyDQPresetCommand}"
									CommandParameter="{Binding SelectedDQPreset}"
									IsEnabled="{Binding SelectedDQPreset, Converter={x:Static ObjectConverters.IsNotNull}}"
									ToolTip.Tip="Load map settings from selected DQ preset"/>
							<StackPanel Orientation="Horizontal" Spacing="4">
								<Button Content="DQ3 Overworld"
										Command="{Binding LoadDQ3OverworldCommand}"
										ToolTip.Tip="Load full DQ3 SNES overworld (256Ã—256 chunk map)"/>
								<Button Content="Chunks"
										Command="{Binding LoadDQ3ChunksCommand}"
										ToolTip.Tip="Load DQ3 chunk definitions"/>
							</StackPanel>
						</StackPanel>

						<Border Background="{DynamicResource SystemControlBackgroundChromeLowBrush}"
								CornerRadius="4" Padding="4">
							<ItemsControl ItemsSource="{Binding TilePalette}">
								<ItemsControl.ItemsPanel>
									<ItemsPanelTemplate>
										<WrapPanel Orientation="Horizontal"/>
									</ItemsPanelTemplate>
								</ItemsControl.ItemsPanel>
								<ItemsControl.ItemTemplate>
									<DataTemplate>
										<Button Width="24" Height="24" Padding="0" Margin="1"
												Content="{Binding Display}" FontSize="8"
												Command="{Binding $parent[ItemsControl].((vm:MapEditorViewModel)DataContext).SelectPaletteTileCommand}"
												CommandParameter="{Binding Index}"
												ToolTip.Tip="{Binding Name}"/>
									</DataTemplate>
								</ItemsControl.ItemTemplate>
							</ItemsControl>
						</Border>

						<StackPanel Orientation="Horizontal" Spacing="4">
							<Button Content="Set Tile" Command="{Binding SetTileCommand}" ToolTip.Tip="Set selected map tile"/>
							<Button Content="Fill All" Command="{Binding FillCommand}" ToolTip.Tip="Fill entire map"/>
						</StackPanel>

						<Separator/>

						<TextBlock Text="Selected Position" FontWeight="SemiBold"/>
						<StackPanel Spacing="2">
							<TextBlock Text="{Binding SelectedX, StringFormat=X: {0}}" Opacity="0.7"/>
							<TextBlock Text="{Binding SelectedY, StringFormat=Y: {0}}" Opacity="0.7"/>
							<TextBlock Text="{Binding SelectedMapTile.TileIndex, StringFormat=Tile: 0x{0:X2}, FallbackValue=Tile: -}" Opacity="0.7"/>
							<TextBlock Text="{Binding SelectedMapTile.Offset, StringFormat=Offset: 0x{0:X6}, FallbackValue=Offset: -}" Opacity="0.7"/>
						</StackPanel>

						<Separator/>

						<TextBlock Text="Selection" FontWeight="SemiBold"/>
						<StackPanel Spacing="2">
							<TextBlock Text="{Binding SelectionStartX, StringFormat=From: ({0}\\,}" Opacity="0.7">
								<Run Text="{Binding SelectionStartY, StringFormat={}{0})}"/>
							</TextBlock>
							<TextBlock Text="{Binding SelectionEndX, StringFormat=To: ({0}\\,}" Opacity="0.7">
								<Run Text="{Binding SelectionEndY, StringFormat={}{0})}"/>
							</TextBlock>
							<Button Content="Clear Selection" Command="{Binding ClearSelectionCommand}" HorizontalAlignment="Left"/>
						</StackPanel>
					</StackPanel>
				</ScrollViewer>
			</Border>
		</Grid>

		<!-- Status Bar -->
		<Border Grid.Row="3" Background="{DynamicResource SystemControlBackgroundChromeMediumLowBrush}" Padding="16,8">
			<Grid ColumnDefinitions="*,Auto,Auto">
				<TextBlock Grid.Column="0" Text="{Binding StatusText}"/>
				<TextBlock Grid.Column="1" Text="{Binding CurrentTool, StringFormat=Tool: {0}}" Margin="16,0"/>
				<TextBlock Grid.Column="2" Text="{Binding MapTiles.Count, StringFormat={}{0} tiles}"/>
			</Grid>
		</Border>
	</Grid>
</UserControl>
