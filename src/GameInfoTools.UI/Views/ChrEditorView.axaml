<UserControl xmlns="https://github.com/avaloniaui"
			 xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
			 xmlns:vm="using:GameInfoTools.UI.ViewModels"
			 xmlns:controls="using:GameInfoTools.UI.Controls"
			 xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
			 xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
			 mc:Ignorable="d" d:DesignWidth="900" d:DesignHeight="700"
			 x:Class="GameInfoTools.UI.Views.ChrEditorView"
			 x:DataType="vm:ChrEditorViewModel">

	<Design.DataContext>
		<vm:ChrEditorViewModel/>
	</Design.DataContext>

	<Grid RowDefinitions="Auto,*,Auto">
		<!-- Toolbar -->
		<StackPanel Grid.Row="0" Orientation="Horizontal" Spacing="8" Margin="16,16,16,8">
			<TextBlock Text="CHR Offset:" VerticalAlignment="Center"/>
			<NumericUpDown Value="{Binding ChrOffset}" Minimum="0" Maximum="16777215" Width="120" FormatString="X6"/>
			<Separator/>
			<TextBlock Text="Format:" VerticalAlignment="Center"/>
			<ComboBox ItemsSource="{Binding AvailableFormats}" SelectedItem="{Binding TileFormat}" Width="120"/>
			<Separator/>
			<TextBlock Text="Zoom:" VerticalAlignment="Center"/>
			<Button Content="-" Command="{Binding ZoomOutCommand}" Width="30"/>
			<TextBlock Text="{Binding Zoom, StringFormat={}{0}x}" VerticalAlignment="Center" Width="30" TextAlignment="Center"/>
			<Button Content="+" Command="{Binding ZoomInCommand}" Width="30"/>
			<Separator/>
			<CheckBox Content="Grid" IsChecked="{Binding ShowGrid}" VerticalAlignment="Center"/>
			<Separator/>
			<TextBlock Text="Palette:" VerticalAlignment="Center"/>
			<ComboBox x:Name="PaletteComboBox"
					  ItemsSource="{Binding PalettePresets}"
					  SelectedIndex="{Binding SelectedPaletteIndex}"
					  Width="130"
					  SelectionChanged="PaletteComboBox_SelectionChanged">
				<ComboBox.ItemTemplate>
					<DataTemplate DataType="vm:PalettePreset">
						<TextBlock Text="{Binding Name}"/>
					</DataTemplate>
				</ComboBox.ItemTemplate>
			</ComboBox>
			<Separator/>
			<Button Content="Export..." Command="{Binding ExportTilesetCommand}" CommandParameter="{Binding $parent[Window]}" ToolTip.Tip="Export tileset to image"/>
			<Button Content="Import..." Command="{Binding ImportTilesetCommand}" CommandParameter="{Binding $parent[Window]}" ToolTip.Tip="Import tileset from image"/>
		</StackPanel>

		<!-- Main Content -->
		<Grid Grid.Row="1" ColumnDefinitions="*,280" Margin="16,8">
			<!-- Tile Grid -->
			<Border Grid.Column="0" Background="{DynamicResource SystemControlBackgroundChromeMediumBrush}"
					CornerRadius="4" Padding="8" Margin="0,0,8,0">
				<DockPanel>
					<StackPanel DockPanel.Dock="Top" Orientation="Horizontal" Spacing="8" Margin="0,0,0,8">
						<TextBlock Text="Tile Grid" FontWeight="SemiBold"/>
						<Button Content="â—€" Command="{Binding PreviousBankCommand}" ToolTip.Tip="Previous Bank"/>
						<TextBlock Text="{Binding SelectedBank, StringFormat=Bank {0}}" VerticalAlignment="Center"/>
						<Button Content="â–¶" Command="{Binding NextBankCommand}" ToolTip.Tip="Next Bank"/>
						<Separator/>
						<Button Content="â†©" Command="{Binding UndoCommand}" ToolTip.Tip="{Binding UndoDescription, StringFormat=Undo: {0}}" IsEnabled="{Binding CanUndo}" Width="30"/>
						<Button Content="â†ª" Command="{Binding RedoCommand}" ToolTip.Tip="{Binding RedoDescription, StringFormat=Redo: {0}}" IsEnabled="{Binding CanRedo}" Width="30"/>
						<Separator/>
						<Button Content="ðŸ“‹" Command="{Binding CopyTileCommand}" ToolTip.Tip="Copy Tile" Width="30"/>
						<Button Content="ðŸ“„" Command="{Binding PasteTileCommand}" ToolTip.Tip="Paste Tile" Width="30" IsEnabled="{Binding HasClipboard}"/>
						<Button Content="ðŸ—‘" Command="{Binding ClearTileCommand}" ToolTip.Tip="Clear Tile" Width="30"/>
					</StackPanel>
					<ScrollViewer HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Auto">
						<!-- Visual Tile Grid using custom control -->
						<controls:TileGridCanvas
							Tiles="{Binding TileGraphics}"
							TilesPerRow="16"
							Palette="{Binding CurrentPalette}"
							Scale="{Binding Zoom}"
							ShowGrid="{Binding ShowGrid}"
							SelectedTileIndex="{Binding SelectedTileIndex, Mode=TwoWay}"
							TileSpacing="1"/>
					</ScrollViewer>
				</DockPanel>
			</Border>

			<!-- Right Panel - Tile Editor -->
			<Border Grid.Column="1" Background="{DynamicResource SystemControlBackgroundChromeMediumBrush}"
					CornerRadius="4" Padding="16">
				<ScrollViewer>
					<StackPanel Spacing="16">
						<TextBlock Text="Tile Editor" FontWeight="SemiBold" FontSize="16"/>

						<!-- Selected Tile Preview -->
						<StackPanel Spacing="8">
							<TextBlock Text="Selected Tile:"/>
							<TextBlock Text="{Binding SelectedTileIndex, StringFormat=Tile ${0:X2}}" FontWeight="SemiBold"/>

							<!-- Large tile preview -->
							<Border Background="Black" CornerRadius="4" Padding="4" HorizontalAlignment="Left">
								<controls:TileCanvas
									TileData="{Binding SelectedTileData}"
									Palette="{Binding CurrentPalette}"
									Scale="8"
									ShowGrid="{Binding ShowGrid}"/>
							</Border>
						</StackPanel>

						<Separator/>

						<!-- Palette Display -->
						<StackPanel Spacing="8">
							<TextBlock Text="Current Palette" FontWeight="SemiBold"/>
							<controls:PaletteEditor
								Colors="{Binding CurrentPalette}"
								SelectedColorIndex="{Binding SelectedColorIndex}"
								SwatchSize="32"
								SwatchSpacing="4"
								IsReadOnly="True"/>
						</StackPanel>

						<Separator/>

						<!-- Transform Previews -->
						<TextBlock Text="Transform Previews" FontWeight="SemiBold"/>
						<TextBlock Text="Click to apply transformation:" Opacity="0.7" FontSize="11"/>

						<Grid ColumnDefinitions="*,*,*" RowDefinitions="Auto,Auto,Auto,Auto" HorizontalAlignment="Left">
							<!-- Row 0: Labels -->
							<TextBlock Grid.Row="0" Grid.Column="0" Text="Flip H" HorizontalAlignment="Center" FontSize="10" Opacity="0.7"/>
							<TextBlock Grid.Row="0" Grid.Column="1" Text="Flip V" HorizontalAlignment="Center" FontSize="10" Opacity="0.7"/>
							<TextBlock Grid.Row="0" Grid.Column="2" Text="90Â°" HorizontalAlignment="Center" FontSize="10" Opacity="0.7"/>

							<!-- Row 1: Previews -->
							<Button Grid.Row="1" Grid.Column="0" Command="{Binding ApplyFlipHorizontalCommand}"
									Background="Transparent" Padding="4" Margin="2">
								<Border Background="Black" CornerRadius="2" Padding="2">
									<controls:TileCanvas TileData="{Binding PreviewFlipH}"
														 Palette="{Binding CurrentPalette}" Scale="4"/>
								</Border>
							</Button>
							<Button Grid.Row="1" Grid.Column="1" Command="{Binding ApplyFlipVerticalCommand}"
									Background="Transparent" Padding="4" Margin="2">
								<Border Background="Black" CornerRadius="2" Padding="2">
									<controls:TileCanvas TileData="{Binding PreviewFlipV}"
														 Palette="{Binding CurrentPalette}" Scale="4"/>
								</Border>
							</Button>
							<Button Grid.Row="1" Grid.Column="2" Command="{Binding ApplyRotate90Command}"
									Background="Transparent" Padding="4" Margin="2">
								<Border Background="Black" CornerRadius="2" Padding="2">
									<controls:TileCanvas TileData="{Binding PreviewRotate90}"
														 Palette="{Binding CurrentPalette}" Scale="4"/>
								</Border>
							</Button>

							<!-- Row 2: Labels -->
							<TextBlock Grid.Row="2" Grid.Column="0" Text="180Â°" HorizontalAlignment="Center" FontSize="10" Opacity="0.7"/>
							<TextBlock Grid.Row="2" Grid.Column="1" Text="270Â°" HorizontalAlignment="Center" FontSize="10" Opacity="0.7"/>

							<!-- Row 3: More Previews -->
							<Button Grid.Row="3" Grid.Column="0" Command="{Binding ApplyRotate180Command}"
									Background="Transparent" Padding="4" Margin="2">
								<Border Background="Black" CornerRadius="2" Padding="2">
									<controls:TileCanvas TileData="{Binding PreviewRotate180}"
														 Palette="{Binding CurrentPalette}" Scale="4"/>
								</Border>
							</Button>
							<Button Grid.Row="3" Grid.Column="1" Command="{Binding ApplyRotate270Command}"
									Background="Transparent" Padding="4" Margin="2">
								<Border Background="Black" CornerRadius="2" Padding="2">
									<controls:TileCanvas TileData="{Binding PreviewRotate270}"
														 Palette="{Binding CurrentPalette}" Scale="4"/>
								</Border>
							</Button>
						</Grid>

						<Separator/>

						<!-- Statistics -->
						<TextBlock Text="Statistics" FontWeight="SemiBold"/>
						<StackPanel Spacing="4">
							<TextBlock Text="{Binding TileCount, StringFormat=Total Tiles: {0}}" Opacity="0.7"/>
							<TextBlock Text="{Binding BankCount, StringFormat=Banks: {0}}" Opacity="0.7"/>
							<TextBlock Text="{Binding TileFormat, StringFormat=Format: {0}}" Opacity="0.7"/>
						</StackPanel>
					</StackPanel>
				</ScrollViewer>
			</Border>
		</Grid>

		<!-- Status Bar -->
		<Border Grid.Row="2" Background="{DynamicResource SystemControlBackgroundChromeMediumLowBrush}" Padding="16,8">
			<TextBlock Text="{Binding StatusText}"/>
		</Border>
	</Grid>
</UserControl>
