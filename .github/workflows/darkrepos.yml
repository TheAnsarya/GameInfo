name: DarkRepos CI/CD

on:
    push:
        branches: [main, develop, feature/darkrepos-wiki]
        paths:
            - "DarkRepos/**"
            - ".github/workflows/darkrepos.yml"
    pull_request:
        branches: [main]
        paths:
            - "DarkRepos/**"
    workflow_dispatch:
        inputs:
            deploy:
                description: "Deploy to GitHub Pages"
                required: false
                type: boolean
                default: false

env:
    DOTNET_VERSION: "10.0.x"
    DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
    DOTNET_CLI_TELEMETRY_OPTOUT: true

jobs:
    build-web:
        name: Build & Test Web
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup .NET
              uses: actions/setup-dotnet@v4
              with:
                  dotnet-version: ${{ env.DOTNET_VERSION }}

            - name: Restore dependencies
              run: dotnet restore DarkRepos/Web/DarkRepos.Web.sln

            - name: Build solution
              run: dotnet build DarkRepos/Web/DarkRepos.Web.sln --no-restore --configuration Release

            - name: Run tests
              run: dotnet test DarkRepos/Web/DarkRepos.Web.sln --no-build --configuration Release --verbosity normal --logger "trx;LogFileName=test-results.trx"

            - name: Upload test results
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: web-test-results
                  path: "**/TestResults/*.trx"

    build-editor:
        name: Build & Test Editor
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup .NET
              uses: actions/setup-dotnet@v4
              with:
                  dotnet-version: ${{ env.DOTNET_VERSION }}

            - name: Restore dependencies
              run: dotnet restore DarkRepos/Editor/DarkRepos.Editor.sln

            - name: Build solution
              run: dotnet build DarkRepos/Editor/DarkRepos.Editor.sln --no-restore --configuration Release

            - name: Run tests
              run: dotnet test DarkRepos/Editor/DarkRepos.Editor.sln --no-build --configuration Release --verbosity normal --logger "trx;LogFileName=test-results.trx"

            - name: Upload test results
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: editor-test-results
                  path: "**/TestResults/*.trx"

    lint-web:
        name: Code Quality (Web)
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup .NET
              uses: actions/setup-dotnet@v4
              with:
                  dotnet-version: ${{ env.DOTNET_VERSION }}

            - name: Restore dependencies
              run: dotnet restore DarkRepos/Web/DarkRepos.Web.sln

            - name: Check formatting
              run: dotnet format DarkRepos/Web/DarkRepos.Web.sln --verify-no-changes --verbosity diagnostic
              continue-on-error: true

            - name: Run analyzers
              run: dotnet build DarkRepos/Web/DarkRepos.Web.sln --configuration Release /p:TreatWarningsAsErrors=false /p:EnforceCodeStyleInBuild=true
              continue-on-error: true

    lint-editor:
        name: Code Quality (Editor)
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup .NET
              uses: actions/setup-dotnet@v4
              with:
                  dotnet-version: ${{ env.DOTNET_VERSION }}

            - name: Restore dependencies
              run: dotnet restore DarkRepos/Editor/DarkRepos.Editor.sln

            - name: Check formatting
              run: dotnet format DarkRepos/Editor/DarkRepos.Editor.sln --verify-no-changes --verbosity diagnostic
              continue-on-error: true

            - name: Run analyzers
              run: dotnet build DarkRepos/Editor/DarkRepos.Editor.sln --configuration Release /p:TreatWarningsAsErrors=false /p:EnforceCodeStyleInBuild=true
              continue-on-error: true

    publish:
        name: Publish WebAssembly
        runs-on: ubuntu-latest
        needs: build-web
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup .NET
              uses: actions/setup-dotnet@v4
              with:
                  dotnet-version: ${{ env.DOTNET_VERSION }}

            - name: Publish WebAssembly
              run: |
                  dotnet publish DarkRepos/Web/src/DarkRepos.Web.Server/DarkRepos.Web.Server.csproj \
                    --configuration Release \
                    --output ./publish \
                    -p:BlazorEnableCompression=true

            - name: Upload publish artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: darkrepos-web
                  path: ./publish/wwwroot
                  retention-days: 7

    deploy-preview:
        name: Deploy PR Preview
        runs-on: ubuntu-latest
        needs: build-web
        if: github.event_name == 'pull_request'
        permissions:
            contents: read
            pull-requests: write

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup .NET
              uses: actions/setup-dotnet@v4
              with:
                  dotnet-version: ${{ env.DOTNET_VERSION }}

            - name: Publish WebAssembly
              run: |
                  dotnet publish DarkRepos/Web/src/DarkRepos.Web.Server/DarkRepos.Web.Server.csproj \
                    --configuration Release \
                    --output ./publish

            - name: Comment PR with build status
              uses: actions/github-script@v7
              with:
                  script: |
                      github.rest.issues.createComment({
                        issue_number: context.issue.number,
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        body: 'âœ… DarkRepos build succeeded! WebAssembly artifacts are ready for review.'
                      })

    security-scan:
        name: Security Scan
        runs-on: ubuntu-latest
        permissions:
            security-events: write

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup .NET
              uses: actions/setup-dotnet@v4
              with:
                  dotnet-version: ${{ env.DOTNET_VERSION }}

            - name: Restore Web dependencies
              run: dotnet restore DarkRepos/Web/DarkRepos.Web.sln

            - name: Restore Editor dependencies
              run: dotnet restore DarkRepos/Editor/DarkRepos.Editor.sln

            - name: Run security audit (Web)
              run: |
                  dotnet list DarkRepos/Web/DarkRepos.Web.sln package --vulnerable --include-transitive 2>&1 | tee security-report-web.txt
                  if grep -q "has the following vulnerable packages" security-report-web.txt; then
                    echo "::warning::Vulnerable packages detected in Web. See security-report-web.txt for details."
                  fi

            - name: Run security audit (Editor)
              run: |
                  dotnet list DarkRepos/Editor/DarkRepos.Editor.sln package --vulnerable --include-transitive 2>&1 | tee security-report-editor.txt
                  if grep -q "has the following vulnerable packages" security-report-editor.txt; then
                    echo "::warning::Vulnerable packages detected in Editor. See security-report-editor.txt for details."
                  fi

            - name: Upload security reports
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: security-reports
                  path: security-report-*.txt
