@namespace DarkRepos.Web.Components.Shared

<div class="accordion @CssClass">
	@foreach (var (item, index) in ItemsToRender.Select((item, i) => (item, i)))
	{
		<div class="accordion-item @(IsExpanded(index) ? "accordion-item--expanded" : "")">
			<button type="button" class="accordion-trigger" @onclick="() => Toggle(index)"
				aria-expanded="@(IsExpanded(index) ? "true" : "false")" aria-controls="@($"accordion-panel-{_id}-{index}")"
				id="@($"accordion-trigger-{_id}-{index}")">
				<span class="accordion-title">@item.Title</span>
				<span class="accordion-icon" aria-hidden="true">
					<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="20" height="20">
						<path fill-rule="evenodd"
							d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z"
							clip-rule="evenodd" />
					</svg>
				</span>
			</button>
			<div class="accordion-panel @(IsExpanded(index) ? "accordion-panel--open" : "")"
				id="@($"accordion-panel-{_id}-{index}")" role="region"
				aria-labelledby="@($"accordion-trigger-{_id}-{index}")" hidden="@(!IsExpanded(index))">
				<div class="accordion-content">
					@item.Content
				</div>
			</div>
		</div>
	}
</div>

@code {
	private readonly string _id = Guid.NewGuid().ToString("N")[..8];
	private HashSet<int> _expandedIndices = new();

	/// <summary>
	/// Accordion items to display.
	/// </summary>
	[Parameter]
	public List<AccordionItem>? Items { get; set; }

	/// <summary>
	/// Whether to allow multiple panels open at once.
	/// </summary>
	[Parameter]
	public bool AllowMultiple { get; set; }

	/// <summary>
	/// Indices of initially expanded items (zero-based).
	/// </summary>
	[Parameter]
	public int[]? DefaultExpanded { get; set; }

	/// <summary>
	/// Additional CSS classes.
	/// </summary>
	[Parameter]
	public string? CssClass { get; set; }

	/// <summary>
	/// Callback when an item is toggled.
	/// </summary>
	[Parameter]
	public EventCallback<int> OnToggle { get; set; }

	private IEnumerable<AccordionItem> ItemsToRender => Items ?? [];

	protected override void OnParametersSet()
	{
		if (DefaultExpanded != null && _expandedIndices.Count == 0)
		{
			foreach (var index in DefaultExpanded)
			{
				_expandedIndices.Add(index);
			}
		}
	}

	private bool IsExpanded(int index) => _expandedIndices.Contains(index);

	private async Task Toggle(int index)
	{
		if (IsExpanded(index))
		{
			_expandedIndices.Remove(index);
		}
		else
		{
			if (!AllowMultiple)
			{
				_expandedIndices.Clear();
			}
			_expandedIndices.Add(index);
		}

		await OnToggle.InvokeAsync(index);
	}

	public class AccordionItem
	{
		public string Title { get; set; } = "";
		public RenderFragment? Content { get; set; }
	}
}