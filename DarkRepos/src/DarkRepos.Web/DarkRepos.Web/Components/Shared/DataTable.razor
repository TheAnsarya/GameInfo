@namespace DarkRepos.Web.Components.Shared
@typeparam TItem

<div class="data-table-container @(IsScrollable ? "scrollable" : "")">
	<table class="data-table" role="grid" aria-label="@AriaLabel">
		@if (ShowHeader && Columns != null) {
			<thead>
				<tr>
					@foreach (var column in Columns) {
						<th scope="col"
							class="@(column.Sortable ? "sortable" : "") @(GetSortClass(column))"
							@onclick="() => HandleSort(column)">
							@column.Header
							@if (column.Sortable) {
								<span class="sort-indicator" aria-hidden="true">
									@if (_sortColumn == column.PropertyName) {
										@(_sortAscending ? "▲" : "▼")
									}
								</span>
							}
						</th>
					}
				</tr>
			</thead>
		}
		<tbody>
			@if (Items != null && Items.Any()) {
				@foreach (var item in GetSortedItems()) {
					<tr class="@RowClass?.Invoke(item)" @onclick="() => OnRowClick.InvokeAsync(item)">
						@if (RowTemplate != null) {
							@RowTemplate(item)
						} else if (Columns != null) {
							@foreach (var column in Columns) {
								<td>@GetCellValue(item, column)</td>
							}
						}
					</tr>
				}
			} else if (EmptyTemplate != null) {
				<tr>
					<td colspan="@(Columns?.Count ?? 1)">
						@EmptyTemplate
					</td>
				</tr>
			} else {
				<tr>
					<td colspan="@(Columns?.Count ?? 1)" class="empty-message">
						@EmptyMessage
					</td>
				</tr>
			}
		</tbody>
	</table>
</div>

@code {
	[Parameter]
	public IEnumerable<TItem>? Items { get; set; }

	[Parameter]
	public List<DataTableColumn<TItem>>? Columns { get; set; }

	[Parameter]
	public RenderFragment<TItem>? RowTemplate { get; set; }

	[Parameter]
	public RenderFragment? EmptyTemplate { get; set; }

	[Parameter]
	public string EmptyMessage { get; set; } = "No data available";

	[Parameter]
	public string AriaLabel { get; set; } = "Data table";

	[Parameter]
	public bool ShowHeader { get; set; } = true;

	[Parameter]
	public bool IsScrollable { get; set; } = false;

	[Parameter]
	public Func<TItem, string>? RowClass { get; set; }

	[Parameter]
	public EventCallback<TItem> OnRowClick { get; set; }

	[Parameter]
	public string? DefaultSortColumn { get; set; }

	[Parameter]
	public bool DefaultSortAscending { get; set; } = true;

	private string? _sortColumn;
	private bool _sortAscending = true;

	protected override void OnParametersSet() {
		if (_sortColumn == null && !string.IsNullOrEmpty(DefaultSortColumn)) {
			_sortColumn = DefaultSortColumn;
			_sortAscending = DefaultSortAscending;
		}
	}

	private void HandleSort(DataTableColumn<TItem> column) {
		if (!column.Sortable) return;

		if (_sortColumn == column.PropertyName) {
			_sortAscending = !_sortAscending;
		} else {
			_sortColumn = column.PropertyName;
			_sortAscending = true;
		}
	}

	private IEnumerable<TItem> GetSortedItems() {
		if (Items == null) return Enumerable.Empty<TItem>();

		if (string.IsNullOrEmpty(_sortColumn) || Columns == null) {
			return Items;
		}

		var column = Columns.FirstOrDefault(c => c.PropertyName == _sortColumn);
		if (column?.SortFunc == null) {
			return Items;
		}

		return _sortAscending
			? Items.OrderBy(column.SortFunc)
			: Items.OrderByDescending(column.SortFunc);
	}

	private string GetSortClass(DataTableColumn<TItem> column) {
		if (_sortColumn != column.PropertyName) return "";
		return _sortAscending ? "sorted-asc" : "sorted-desc";
	}

	private object? GetCellValue(TItem item, DataTableColumn<TItem> column) {
		if (column.ValueFunc != null) {
			return column.ValueFunc(item);
		}

		if (string.IsNullOrEmpty(column.PropertyName)) {
			return null;
		}

		var property = typeof(TItem).GetProperty(column.PropertyName);
		return property?.GetValue(item);
	}

	public class DataTableColumn<T> {
		public string Header { get; set; } = string.Empty;
		public string? PropertyName { get; set; }
		public Func<T, object?>? ValueFunc { get; set; }
		public Func<T, object?>? SortFunc { get; set; }
		public bool Sortable { get; set; }
		public string? CssClass { get; set; }
	}
}
