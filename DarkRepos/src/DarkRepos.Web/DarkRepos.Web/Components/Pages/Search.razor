@page "/search"
@using DarkRepos.Core.Models
@using DarkRepos.Core.Services
@using DarkRepos.Web.Components.Shared

<PageTitle>Search - Dark Repos</PageTitle>

<HeadContent>
	<meta name="description" content="Search for games, tools, and documentation across Dark Repos." />
</HeadContent>

<div class="container">
	<Breadcrumbs Items="@_breadcrumbItems" />

	<header class="page-header">
		<h1 class="page-title">Search</h1>
		<p class="page-description">
			Search across games, tools, and documentation.
		</p>
	</header>

	<div class="search-container mb-6">
		<form @onsubmit="HandleSearch" @onsubmit:preventDefault>
			<div class="flex gap-3">
				<input type="search" @bind="SearchTerms" @bind:event="oninput"
					placeholder="Search games, tools, documentation..." class="search-input"
					style="flex: 1; padding: var(--space-3); font-size: var(--font-size-md); border: 1px solid var(--color-border); border-radius: var(--radius-md); background: var(--color-bg-secondary); color: var(--color-text-primary);"
					aria-label="Search terms" />
				<button type="submit" class="btn btn-primary">Search</button>
			</div>
		</form>
	</div>

	<div class="filter-bar" role="group" aria-label="Filter search results by type">
		<span class="text-secondary text-sm">Type:</span>
		<div class="filter-group">
			<button class="filter-chip @(SelectedType == null ? "active" : "")" @onclick="() => FilterByType(null)">
				All
			</button>
			<button class="filter-chip @(SelectedType == SearchDocumentType.Game ? "active" : "")"
				@onclick="() => FilterByType(SearchDocumentType.Game)">
				Games
			</button>
			<button class="filter-chip @(SelectedType == SearchDocumentType.Tool ? "active" : "")"
				@onclick="() => FilterByType(SearchDocumentType.Tool)">
				Tools
			</button>
			<button class="filter-chip @(SelectedType == SearchDocumentType.Documentation ? "active" : "")"
				@onclick="() => FilterByType(SearchDocumentType.Documentation)">
				Docs
			</button>
		</div>
	</div>

	@if (IsSearching)
	{
		<LoadingSpinner Message="Searching..." />
	}
	else if (HasSearched)
	{
		@if (Results != null && Results.Results.Count > 0)
		{
			<p class="text-secondary mb-4">
				Found @Results.TotalCount result(s) in @Results.Duration.TotalMilliseconds.ToString("0.00")ms
			</p>

			<div class="search-results" role="list">
				@foreach (var result in Results.Results)
				{
					<article class="search-result card mb-4" role="listitem">
						<div class="flex gap-4" style="align-items: flex-start;">
							<div class="search-result-icon" style="font-size: 1.5rem; flex-shrink: 0;">
								@GetResultIcon(result.Document.Type)
							</div>
							<div style="flex: 1;">
								<div class="flex gap-2 mb-2" style="align-items: center;">
									<span class="badge"
										style="background: var(--color-bg-tertiary); font-size: var(--font-size-xs);">
										@result.Document.Type
									</span>
									@if (!string.IsNullOrEmpty(result.Document.Platform))
									{
										<span class="badge badge-@result.Document.Platform.ToLower()"
											style="font-size: var(--font-size-xs);">
											@result.Document.Platform
										</span>
									}
								</div>
								<h3 class="mb-2" style="margin-top: 0;">
									<a href="@result.Document.Url">@((MarkupString)(result.HighlightedTitle ??
																	result.Document.Title))</a>
								</h3>
								@if (!string.IsNullOrEmpty(result.HighlightedSnippet) ||
													!string.IsNullOrEmpty(result.Document.Description))
								{
									<p class="text-secondary text-sm mb-0">
										@((MarkupString)(result.HighlightedSnippet ?? result.Document.Description ?? ""))
									</p>
								}
							</div>
						</div>
					</article>
				}
			</div>

			@if (Results.TotalCount > Results.Results.Count)
			{
				<p class="text-secondary text-center">
					Showing @Results.Results.Count of @Results.TotalCount results
				</p>
			}
		}
		else
		{
			@if (!string.IsNullOrEmpty(SearchTerms))
			{
				<EmptyState Icon="üîç" Title="No results found"
					Message="@($"No results found for \"{SearchTerms}\". Try different search terms.")" />
			}
			else
			{
				<EmptyState Icon="üîç" Title="No results found"
					Message="Enter search terms above to find games, tools, and documentation." />
			}
		}
	}
	else
	{
		<EmptyState Icon="üîç" Title="Ready to search"
			Message="Enter search terms above to find games, tools, and documentation." />
	}
</div>

@code {
	[Inject]
	private ISearchService SearchService { get; set; } = null!;

	[SupplyParameterFromQuery(Name = "q")]
	public string? QueryParam { get; set; }

	private string SearchTerms { get; set; } = string.Empty;
	private SearchDocumentType? SelectedType { get; set; }
	private SearchResults? Results { get; set; }
	private bool IsSearching { get; set; }
	private bool HasSearched { get; set; }

	protected override async Task OnInitializedAsync()
	{
		if (!string.IsNullOrWhiteSpace(QueryParam))
		{
			SearchTerms = QueryParam;
			await PerformSearch();
		}
	}

	private async Task HandleSearch()
	{
		await PerformSearch();
	}

	private async Task PerformSearch()
	{
		if (string.IsNullOrWhiteSpace(SearchTerms))
		{
			Results = null;
			HasSearched = false;
			return;
		}

		IsSearching = true;
		HasSearched = true;
		StateHasChanged();

		try
		{
			var query = new SearchQuery
			{
				Terms = SearchTerms,
				Type = SelectedType,
				Limit = 20
			};

			Results = await SearchService.SearchAsync(query);
		}
		finally
		{
			IsSearching = false;
			StateHasChanged();
		}
	}

	private async Task FilterByType(SearchDocumentType? type)
	{
		SelectedType = type;
		if (HasSearched)
		{
			await PerformSearch();
		}
	}

	private string GetResultIcon(SearchDocumentType type) => type switch
	{
		SearchDocumentType.Game => "üéÆ",
		SearchDocumentType.Tool => "üîß",
		SearchDocumentType.Documentation => "üìÑ",
		SearchDocumentType.Wiki => "üìö",
		SearchDocumentType.Guide => "üìñ",
		_ => "üìã"
	};

	private static readonly IReadOnlyList<Breadcrumbs.BreadcrumbItem> _breadcrumbItems = [
		new("Home", "/", "üè†"),
		new("Search", "/search", "üîç")
	];
}