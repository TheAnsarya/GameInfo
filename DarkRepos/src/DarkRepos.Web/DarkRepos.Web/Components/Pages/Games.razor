@page "/games"
@page "/games/{Platform}"
@using DarkRepos.Core.Models
@using DarkRepos.Core.Services

<PageTitle>Games - Dark Repos</PageTitle>

<HeadContent>
	<meta name="description" content="Browse our catalog of documented retro games with ROM maps, RAM maps, and data structures." />
</HeadContent>

<div class="container">
	<nav class="breadcrumbs" aria-label="Breadcrumb">
		<span class="breadcrumb-item"><a href="/">Home</a></span>
		<span class="breadcrumb-separator" aria-hidden="true">/</span>
		<span class="breadcrumb-item" aria-current="page">Games</span>
	</nav>

	<header class="page-header">
		<h1 class="page-title">Games Catalog</h1>
		<p class="page-description">
			Browse our collection of documented retro games with ROM maps, RAM maps, and detailed data structures.
		</p>
	</header>

	<div class="filter-bar" role="group" aria-label="Filter games by platform">
		<span style="color: var(--color-text-secondary); font-size: var(--font-size-sm);">Platform:</span>
		<div class="filter-group">
			<button class="filter-chip @(string.IsNullOrEmpty(Platform) ? "active" : "")"
					@onclick="@(() => FilterByPlatform(null))">
				All
			</button>
			<button class="filter-chip @(Platform == "nes" ? "active" : "")"
					@onclick="@(() => FilterByPlatform("nes"))">
				NES
			</button>
			<button class="filter-chip @(Platform == "snes" ? "active" : "")"
					@onclick="@(() => FilterByPlatform("snes"))">
				SNES
			</button>
			<button class="filter-chip @(Platform == "gb" ? "active" : "")"
					@onclick="@(() => FilterByPlatform("gb"))">
				GB
			</button>
			<button class="filter-chip @(Platform == "gbc" ? "active" : "")"
					@onclick="@(() => FilterByPlatform("gbc"))">
				GBC
			</button>
			<button class="filter-chip @(Platform == "gba" ? "active" : "")"
					@onclick="@(() => FilterByPlatform("gba"))">
				GBA
			</button>
			<button class="filter-chip @(Platform == "genesis" ? "active" : "")"
					@onclick="@(() => FilterByPlatform("genesis"))">
				Genesis
			</button>
		</div>
	</div>

	@if (IsLoading)
	{
		<div class="loading-state">
			<div class="loading-spinner"></div>
			<p>Loading games...</p>
		</div>
	}
	else if (FilteredGames.Any())
	{
		<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3" role="list">
			@foreach (var game in FilteredGames)
			{
				<article class="game-card" role="listitem">
					<div class="game-card-image">
						@if (!string.IsNullOrEmpty(game.CoverImage))
						{
							<img src="@game.CoverImage" alt="@game.Title cover art" loading="lazy" />
						}
						else
						{
							<span>No Cover</span>
						}
					</div>
					<div class="game-card-content">
						<span class="badge badge-@game.Platform.ToString().ToLower() game-card-platform">
							@game.Platform
						</span>
						<h2 class="game-card-title">
							<a href="/games/@game.Slug">@game.Title</a>
						</h2>
						@if (!string.IsNullOrEmpty(game.Developer))
						{
							<p class="game-card-meta">
								<span>@game.Developer</span>
								@if (game.ReleaseYear.HasValue)
								{
									<span>@game.ReleaseYear</span>
								}
							</p>
						}
						<div class="wiki-resources">
							<span class="wiki-resource @(game.Wiki.HasRomMap ? "available" : "")">
								ROM Map
							</span>
							<span class="wiki-resource @(game.Wiki.HasRamMap ? "available" : "")">
								RAM Map
							</span>
							<span class="wiki-resource @(game.Wiki.HasDataStructures ? "available" : "")">
								Data
							</span>
						</div>
					</div>
				</article>
			}
		</div>

		<p role="status" class="sr-only">Showing @FilteredGames.Count() games</p>
	}
	else
	{
		<div class="empty-state">
			<div class="empty-state-icon">ðŸŽ®</div>
			<h2 class="empty-state-title">No games found</h2>
			<p class="empty-state-description">
				@if (!string.IsNullOrEmpty(Platform))
				{
					<text>No games found for the selected platform. Try a different filter.</text>
				}
				else
				{
					<text>No games have been added yet. Check back soon!</text>
				}
			</p>
			@if (!string.IsNullOrEmpty(Platform))
			{
				<button class="btn btn-secondary" @onclick="() => FilterByPlatform(null)">
					Show all games
				</button>
			}
		</div>
	}
</div>

@code {
	[Parameter]
	public string? Platform { get; set; }

	[Inject]
	private IContentService ContentService { get; set; } = null!;

	private List<Game> AllGames { get; set; } = new();
	private bool IsLoading { get; set; } = true;

	private IEnumerable<Game> FilteredGames => string.IsNullOrEmpty(Platform)
		? AllGames
		: AllGames.Where(g => g.Platform.ToString().Equals(Platform, StringComparison.OrdinalIgnoreCase));

	protected override async Task OnInitializedAsync()
	{
		IsLoading = true;
		try
		{
			var games = await ContentService.GetAllGamesAsync();
			AllGames = games.ToList();
		}
		finally
		{
			IsLoading = false;
		}
	}

	private void FilterByPlatform(string? platform)
	{
		Platform = platform;
		StateHasChanged();
	}
}
