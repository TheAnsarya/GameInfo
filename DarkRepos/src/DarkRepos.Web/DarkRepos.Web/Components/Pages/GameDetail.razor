@page "/games/{Slug}"
@using DarkRepos.Core.Models
@using DarkRepos.Core.Services

<PageTitle>@(Game?.Title ?? "Game") - Dark Repos</PageTitle>

@if (Game != null)
{
	<HeadContent>
		<meta name="description" content="@Game.Title documentation including ROM maps, RAM maps, and data structures for ROM hackers." />
	</HeadContent>
}

<div class="container">
	<nav class="breadcrumbs" aria-label="Breadcrumb">
		<span class="breadcrumb-item"><a href="/">Home</a></span>
		<span class="breadcrumb-separator" aria-hidden="true">/</span>
		<span class="breadcrumb-item"><a href="/games">Games</a></span>
		<span class="breadcrumb-separator" aria-hidden="true">/</span>
		<span class="breadcrumb-item" aria-current="page">@(Game?.Title ?? "Game")</span>
	</nav>

	@if (IsLoading)
	{
		<div class="loading-state">
			<div class="loading-spinner"></div>
			<p>Loading game details...</p>
		</div>
	}
	else if (Game != null)
	{
		<article>
			<header class="page-header">
				<span class="badge badge-@Game.Platform.ToString().ToLower()" style="margin-bottom: var(--space-3);">
					@Game.Platform
				</span>
				<h1 class="page-title">@Game.Title</h1>
				@if (!string.IsNullOrEmpty(Game.JapaneseTitle))
				{
					<p style="color: var(--color-text-secondary); font-size: var(--font-size-md);">
						Japanese: @Game.JapaneseTitle
					</p>
				}
			</header>

			<div class="grid grid-cols-1 md:grid-cols-3" style="gap: var(--space-6);">
				<div style="grid-column: span 2;">
					@if (!string.IsNullOrEmpty(Game.Description))
					{
						<section aria-labelledby="description-title">
							<h2 id="description-title">About</h2>
							<p>@Game.Description</p>
						</section>
					}

					<section aria-labelledby="wiki-title" style="margin-top: var(--space-8);">
						<h2 id="wiki-title">Wiki Resources</h2>
						<p>
							Visit the game's wiki page for comprehensive technical documentation.
						</p>

						<div class="grid grid-cols-1 sm:grid-cols-2" style="gap: var(--space-4); margin-top: var(--space-4);">
							@if (Game.Wiki.HasRomMap)
							{
								<a href="@GetWikiUrl("ROM Map")" target="_blank" rel="noopener" class="card" style="text-decoration: none;">
									<h3 style="font-size: var(--font-size-md); margin-bottom: var(--space-2);">
										üìç ROM Map
									</h3>
									<p style="color: var(--color-text-secondary); margin: 0; font-size: var(--font-size-sm);">
										File offset locations for code and data
									</p>
								</a>
							}
							@if (Game.Wiki.HasRamMap)
							{
								<a href="@GetWikiUrl("RAM Map")" target="_blank" rel="noopener" class="card" style="text-decoration: none;">
									<h3 style="font-size: var(--font-size-md); margin-bottom: var(--space-2);">
										üß† RAM Map
									</h3>
									<p style="color: var(--color-text-secondary); margin: 0; font-size: var(--font-size-sm);">
										Memory addresses for game state
									</p>
								</a>
							}
							@if (Game.Wiki.HasDataStructures)
							{
								<a href="@GetWikiUrl("Data Structures")" target="_blank" rel="noopener" class="card" style="text-decoration: none;">
									<h3 style="font-size: var(--font-size-md); margin-bottom: var(--space-2);">
										üìä Data Structures
									</h3>
									<p style="color: var(--color-text-secondary); margin: 0; font-size: var(--font-size-sm);">
										Format specifications for game data
									</p>
								</a>
							}
							@if (Game.Wiki.HasNotes)
							{
								<a href="@GetWikiUrl("Notes")" target="_blank" rel="noopener" class="card" style="text-decoration: none;">
									<h3 style="font-size: var(--font-size-md); margin-bottom: var(--space-2);">
										üìù Notes
									</h3>
									<p style="color: var(--color-text-secondary); margin: 0; font-size: var(--font-size-sm);">
										General documentation and research
									</p>
								</a>
							}
						</div>

						<p style="margin-top: var(--space-6);">
							<a href="@GetWikiBaseUrl()" target="_blank" rel="noopener" class="btn btn-primary">
								View Full Wiki Page ‚Üí
							</a>
						</p>
					</section>

					@if (Game.RelatedTools.Any())
					{
						<section aria-labelledby="tools-title" style="margin-top: var(--space-8);">
							<h2 id="tools-title">Related Tools</h2>
							<ul>
								@foreach (var tool in Game.RelatedTools)
								{
									<li><a href="/tools/@tool">@tool</a></li>
								}
							</ul>
						</section>
					}
				</div>

				<aside>
					<div class="card">
						<h3 style="font-size: var(--font-size-md); margin-bottom: var(--space-4);">Game Info</h3>
						<dl style="margin: 0;">
							<div style="margin-bottom: var(--space-3);">
								<dt style="color: var(--color-text-muted); font-size: var(--font-size-sm);">Platform</dt>
								<dd style="margin: 0;">@Game.Platform</dd>
							</div>
							@if (!string.IsNullOrEmpty(Game.Developer))
							{
								<div style="margin-bottom: var(--space-3);">
									<dt style="color: var(--color-text-muted); font-size: var(--font-size-sm);">Developer</dt>
									<dd style="margin: 0;">@Game.Developer</dd>
								</div>
							}
							@if (!string.IsNullOrEmpty(Game.Publisher))
							{
								<div style="margin-bottom: var(--space-3);">
									<dt style="color: var(--color-text-muted); font-size: var(--font-size-sm);">Publisher</dt>
									<dd style="margin: 0;">@Game.Publisher</dd>
								</div>
							}
							@if (Game.ReleaseYear.HasValue)
							{
								<div style="margin-bottom: var(--space-3);">
									<dt style="color: var(--color-text-muted); font-size: var(--font-size-sm);">Release Year</dt>
									<dd style="margin: 0;">@Game.ReleaseYear</dd>
								</div>
							}
							@if (!string.IsNullOrEmpty(Game.Genre))
							{
								<div style="margin-bottom: var(--space-3);">
									<dt style="color: var(--color-text-muted); font-size: var(--font-size-sm);">Genre</dt>
									<dd style="margin: 0;">@Game.Genre</dd>
								</div>
							}
							@if (!string.IsNullOrEmpty(Game.Series))
							{
								<div style="margin-bottom: var(--space-3);">
									<dt style="color: var(--color-text-muted); font-size: var(--font-size-sm);">Series</dt>
									<dd style="margin: 0;">
										<a href="/games?series=@Game.Series">@Game.Series</a>
									</dd>
								</div>
							}
						</dl>
					</div>

					<div class="card" style="margin-top: var(--space-4);">
						<h3 style="font-size: var(--font-size-md); margin-bottom: var(--space-4);">Documentation Status</h3>
						<div style="display: flex; flex-direction: column; gap: var(--space-2);">
							<span class="wiki-resource @(Game.Wiki.HasRomMap ? "available" : "")">
								@(Game.Wiki.HasRomMap ? "‚úì" : "‚óã") ROM Map
							</span>
							<span class="wiki-resource @(Game.Wiki.HasRamMap ? "available" : "")">
								@(Game.Wiki.HasRamMap ? "‚úì" : "‚óã") RAM Map
							</span>
							<span class="wiki-resource @(Game.Wiki.HasDataStructures ? "available" : "")">
								@(Game.Wiki.HasDataStructures ? "‚úì" : "‚óã") Data Structures
							</span>
							<span class="wiki-resource @(Game.Wiki.HasSystems ? "available" : "")">
								@(Game.Wiki.HasSystems ? "‚úì" : "‚óã") Systems
							</span>
							<span class="wiki-resource @(Game.Wiki.HasNotes ? "available" : "")">
								@(Game.Wiki.HasNotes ? "‚úì" : "‚óã") Notes
							</span>
						</div>
					</div>
				</aside>
			</div>
		</article>
	}
	else
	{
		<div class="empty-state">
			<div class="empty-state-icon">üéÆ</div>
			<h1 class="empty-state-title">Game Not Found</h1>
			<p class="empty-state-description">
				We couldn't find a game with the slug "@Slug".
			</p>
			<a href="/games" class="btn btn-primary">Browse All Games</a>
		</div>
	}
</div>

@code {
	[Parameter]
	public string Slug { get; set; } = string.Empty;

	[Inject]
	private IContentService ContentService { get; set; } = null!;

	private Game? Game { get; set; }
	private bool IsLoading { get; set; } = true;

	protected override async Task OnParametersSetAsync()
	{
		IsLoading = true;
		try
		{
			Game = await ContentService.GetGameBySlugAsync(Slug);
		}
		finally
		{
			IsLoading = false;
		}
	}

	private string GetWikiBaseUrl()
	{
		return Game?.Wiki.WikiBaseUrl ?? $"https://games.darkrepos.com/wiki/{Game?.Title.Replace(" ", "_")}";
	}

	private string GetWikiUrl(string section)
	{
		var baseUrl = GetWikiBaseUrl();
		return $"{baseUrl}:{section.Replace(" ", "_")}";
	}
}
