@inherits LayoutComponentBase
@inject NavigationManager Navigation
@inject IJSRuntime JS
@using DarkRepos.Web.Components.Shared
@implements IAsyncDisposable

<a href="#main-content" class="skip-link">Skip to main content</a>
<a href="#navigation" class="skip-link">Skip to navigation</a>

<PageLoadingIndicator />

<div class="page-wrapper" @onkeydown="HandleGlobalKeyDown" tabindex="-1" @ref="_pageWrapper">
	<header class="site-header" role="banner">
		<div class="header-inner">
			<a href="/" class="site-logo" aria-label="Dark Repos Home">
				<svg width="32" height="32" viewBox="0 0 32 32" fill="currentColor" aria-hidden="true">
					<rect x="2" y="4" width="28" height="24" rx="2" fill="none" stroke="currentColor"
						stroke-width="2" />
					<path d="M8 12h16M8 16h12M8 20h8" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
				</svg>
				<span>Dark Repos</span>
			</a>

			<nav id="navigation" class="main-nav @(_isMobileMenuOpen ? "mobile-open" : "")" role="navigation" aria-label="Main navigation">
				<NavLink href="/" class="nav-link" Match="NavLinkMatch.All" @onclick="CloseMobileMenu">
					<span>Home</span>
				</NavLink>
				<NavLink href="/games" class="nav-link" @onclick="CloseMobileMenu">
					<span>Games</span>
				</NavLink>
				<NavLink href="/tools" class="nav-link" @onclick="CloseMobileMenu">
					<span>Tools</span>
				</NavLink>
				<NavLink href="/docs" class="nav-link" @onclick="CloseMobileMenu">
					<span>Docs</span>
				</NavLink>
			</nav>

			<form class="header-search" @onsubmit="HandleSearch" @onsubmit:preventDefault>
				<svg class="search-icon" width="16" height="16" viewBox="0 0 16 16" fill="currentColor"
					aria-hidden="true">
					<path
						d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z" />
				</svg>
				<input type="search" @bind="SearchQuery" class="search-input" placeholder="Search... (Ctrl+K)"
					aria-label="Search games and tools" @onfocus="OpenSearchModal" />
			</form>

			<ThemeToggle />

			<button class="mobile-menu-btn" @onclick="ToggleMobileMenu" aria-label="@(_isMobileMenuOpen ? "Close navigation menu" : "Open navigation menu")" aria-expanded="@_isMobileMenuOpen.ToString().ToLower()">
				@if (_isMobileMenuOpen) {
					<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
						<path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" />
					</svg>
				} else {
					<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
						<path d="M3 6h18v2H3V6zm0 5h18v2H3v-2zm0 5h18v2H3v-2z" />
					</svg>
				}
			</button>
		</div>
	</header>

	<main id="main-content" class="main-content" role="main">
		@Body
	</main>

	<footer class="site-footer" role="contentinfo">
		<div class="footer-inner">
			<div class="footer-grid">
				<div class="footer-section">
					<h3>Games</h3>
					<ul class="footer-links">
						<li><a href="/games?platform=nes">NES Games</a></li>
						<li><a href="/games?platform=snes">SNES Games</a></li>
						<li><a href="/games?platform=gb">Game Boy</a></li>
						<li><a href="/games?platform=gba">GBA Games</a></li>
					</ul>
				</div>
				<div class="footer-section">
					<h3>Resources</h3>
					<ul class="footer-links">
						<li><a href="/tools">Tools</a></li>
						<li><a href="/docs">Documentation</a></li>
						<li><a href="https://games.darkrepos.com" target="_blank" rel="noopener">Wiki</a></li>
					</ul>
				</div>
				<div class="footer-section">
					<h3>Community</h3>
					<ul class="footer-links">
						<li><a href="https://github.com/TheAnsarya/GameInfo" target="_blank" rel="noopener">GitHub</a>
						</li>
						<li><a href="/contribute">Contributing</a></li>
						<li><a href="/about">About</a></li>
					</ul>
				</div>
			</div>
			<div class="footer-bottom">
				<p>&copy; @DateTime.Now.Year Dark Repos. Open source under MIT License.</p>
				<p>Built for the ROM hacking community.</p>
			</div>
		</div>
	</footer>
</div>

<SearchModal @ref="_searchModal" OnClose="HandleSearchModalClose" />
<ScrollToTopButton />

@code {
	private string SearchQuery { get; set; } = string.Empty;
	private SearchModal? _searchModal;
	private ElementReference _pageWrapper;
	private bool _isMobileMenuOpen = false;

	private void HandleSearch() {
		if (!string.IsNullOrWhiteSpace(SearchQuery)) {
			Navigation.NavigateTo($"/search?q={Uri.EscapeDataString(SearchQuery)}");
		}
	}

	private void OpenSearchModal() {
		_searchModal?.Open();
	}

	private void HandleSearchModalClose() {
		// Modal closed
	}

	private void ToggleMobileMenu() {
		_isMobileMenuOpen = !_isMobileMenuOpen;
	}

	private void CloseMobileMenu() {
		_isMobileMenuOpen = false;
	}

	private void HandleGlobalKeyDown(KeyboardEventArgs e) {
		// Ctrl+K or Cmd+K to open search modal
		if ((e.CtrlKey || e.MetaKey) && e.Key == "k") {
			OpenSearchModal();
		}
		// Forward slash "/" to open search (when not in input)
		else if (e.Key == "/" && !IsInInputElement(e)) {
			OpenSearchModal();
		}
		// Escape to close mobile menu
		else if (e.Key == "Escape" && _isMobileMenuOpen) {
			_isMobileMenuOpen = false;
		}
	}

	private bool IsInInputElement(KeyboardEventArgs e) {
		// This is a simplified check - in a real app you'd use JS interop
		// to check the actual active element
		return false;
	}

	public ValueTask DisposeAsync() {
		return ValueTask.CompletedTask;
	}
}