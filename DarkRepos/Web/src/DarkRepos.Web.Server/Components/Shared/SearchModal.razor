@namespace DarkRepos.Web.Components.Shared
@inject NavigationManager Navigation
@implements IAsyncDisposable

@if (IsOpen)
{
	<div class="search-modal-overlay" @onclick="Close" @onkeydown="HandleOverlayKeyDown">
		<div class="search-modal" @onclick:stopPropagation @onkeydown="HandleKeyDown" role="dialog" aria-modal="true" aria-label="Quick search">
			<div class="search-modal-header">
				<div class="search-modal-input-wrapper">
					<svg class="search-modal-icon" width="20" height="20" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true">
						<path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z" />
					</svg>
					<input @ref="_inputRef" type="search" @bind="SearchQuery" @bind:event="oninput"
						placeholder="Search games, tools, docs..."
						class="search-modal-input"
						aria-label="Search query" />
					<kbd class="search-modal-kbd">Esc</kbd>
				</div>
			</div>

			@if (!string.IsNullOrWhiteSpace(SearchQuery))
			{
				<div class="search-modal-body">
					<div class="search-modal-hint">
						Press <kbd>Enter</kbd> to search or <kbd>Esc</kbd> to close
					</div>
					<div class="search-modal-shortcuts">
						<a href="/games?q=@Uri.EscapeDataString(SearchQuery)" class="search-shortcut" @onclick="Close">
							<span class="search-shortcut-icon">ğŸ®</span>
							<span>Search in Games</span>
						</a>
						<a href="/tools?q=@Uri.EscapeDataString(SearchQuery)" class="search-shortcut" @onclick="Close">
							<span class="search-shortcut-icon">ğŸ”§</span>
							<span>Search in Tools</span>
						</a>
						<a href="/docs?q=@Uri.EscapeDataString(SearchQuery)" class="search-shortcut" @onclick="Close">
							<span class="search-shortcut-icon">ğŸ“š</span>
							<span>Search in Docs</span>
						</a>
					</div>
				</div>
			}
			else
			{
				<div class="search-modal-body">
					<div class="search-modal-hint">
						Type to search across all content
					</div>
					<div class="search-modal-recent">
						<h4 class="search-modal-section-title">Quick Links</h4>
						<a href="/games" class="search-quick-link" @onclick="Close">
							<span class="search-shortcut-icon">ğŸ®</span>
							<span>Browse Games</span>
						</a>
						<a href="/tools" class="search-quick-link" @onclick="Close">
							<span class="search-shortcut-icon">ğŸ”§</span>
							<span>Browse Tools</span>
						</a>
						<a href="/docs" class="search-quick-link" @onclick="Close">
							<span class="search-shortcut-icon">ğŸ“š</span>
							<span>Documentation</span>
						</a>
						<a href="/about" class="search-quick-link" @onclick="Close">
							<span class="search-shortcut-icon">â„¹ï¸</span>
							<span>About</span>
						</a>
					</div>
				</div>
			}

			<div class="search-modal-footer">
				<span class="search-modal-tip">
					<kbd>â†‘</kbd><kbd>â†“</kbd> to navigate
					<kbd>Enter</kbd> to select
					<kbd>Esc</kbd> to close
				</span>
			</div>
		</div>
	</div>
}

@code {
	private ElementReference _inputRef;
	private string SearchQuery { get; set; } = string.Empty;
	private bool IsOpen { get; set; }

	[Parameter]
	public EventCallback OnClose { get; set; }

	protected override async Task OnAfterRenderAsync(bool firstRender) {
		if (IsOpen && _inputRef.Context != null) {
			try {
				await _inputRef.FocusAsync();
			} catch {
				// Element might not be ready
			}
		}
	}

	public void Open() {
		IsOpen = true;
		SearchQuery = string.Empty;
		StateHasChanged();
	}

	public void Close() {
		IsOpen = false;
		StateHasChanged();
		OnClose.InvokeAsync();
	}

	private void HandleKeyDown(KeyboardEventArgs e) {
		if (e.Key == "Escape") {
			Close();
		} else if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(SearchQuery)) {
			Navigation.NavigateTo($"/search?q={Uri.EscapeDataString(SearchQuery)}");
			Close();
		}
	}

	private void HandleOverlayKeyDown(KeyboardEventArgs e) {
		if (e.Key == "Escape") {
			Close();
		}
	}

	public ValueTask DisposeAsync() {
		return ValueTask.CompletedTask;
	}
}
