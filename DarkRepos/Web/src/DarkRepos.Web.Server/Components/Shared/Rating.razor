@namespace DarkRepos.Web.Components.Shared

@*
	Rating - Star rating display/input
	Usage: <Rating Value="@rating" MaxValue="5" OnValueChanged="@HandleChange" />
	Features:
	- Display or input mode
	- Customizable max value
	- Half-star support
	- Accessible
*@

<div class="rating @(Readonly ? "readonly" : "interactive") @(Size)"
	role="@(Readonly ? "img" : "slider")"
	aria-label="@GetAriaLabel()"
	aria-valuenow="@Value"
	aria-valuemin="0"
	aria-valuemax="@MaxValue"
	tabindex="@(Readonly ? -1 : 0)"
	@onkeydown="HandleKeyDown">
	@for (var i = 1; i <= MaxValue; i++)
	{
		var starIndex = i;
		<span class="star @GetStarClass(i)"
			@onclick="() => HandleClick(starIndex)"
			@onmouseover="() => HandleHover(starIndex)"
			@onmouseout="HandleMouseOut"
			aria-hidden="true">
			@GetStarIcon(i)
		</span>
	}
	@if (ShowValue)
	{
		<span class="rating-value">@Value.ToString("0.#") / @MaxValue</span>
	}
	@if (ShowCount && Count.HasValue)
	{
		<span class="rating-count">(@Count.Value.ToString("N0"))</span>
	}
</div>

@code {
	/// <summary>
	/// The current rating value.
	/// </summary>
	[Parameter]
	public double Value { get; set; }

	/// <summary>
	/// Maximum rating value.
	/// </summary>
	[Parameter]
	public int MaxValue { get; set; } = 5;

	/// <summary>
	/// Whether the rating is read-only (display mode).
	/// </summary>
	[Parameter]
	public bool Readonly { get; set; } = true;

	/// <summary>
	/// Allow half-star ratings.
	/// </summary>
	[Parameter]
	public bool AllowHalf { get; set; }

	/// <summary>
	/// Show the numeric value.
	/// </summary>
	[Parameter]
	public bool ShowValue { get; set; }

	/// <summary>
	/// Number of ratings (for display).
	/// </summary>
	[Parameter]
	public int? Count { get; set; }

	/// <summary>
	/// Show the rating count.
	/// </summary>
	[Parameter]
	public bool ShowCount { get; set; }

	/// <summary>
	/// Size variant.
	/// </summary>
	[Parameter]
	public string Size { get; set; } = "medium";

	/// <summary>
	/// Callback when value changes.
	/// </summary>
	[Parameter]
	public EventCallback<double> OnValueChanged { get; set; }

	private double _hoverValue;
	private bool _isHovering;

	private string GetStarClass(int index)
	{
		var effectiveValue = _isHovering ? _hoverValue : Value;

		if (effectiveValue >= index)
		{
			return "filled";
		}
		else if (AllowHalf && effectiveValue >= index - 0.5)
		{
			return "half";
		}

		return "empty";
	}

	private string GetStarIcon(int index)
	{
		var effectiveValue = _isHovering ? _hoverValue : Value;

		if (effectiveValue >= index)
		{
			return "★";
		}
		else if (AllowHalf && effectiveValue >= index - 0.5)
		{
			return "★"; // CSS will handle the half display
		}

		return "☆";
	}

	private async Task HandleClick(int index)
	{
		if (Readonly)
		{
			return;
		}

		var newValue = (double)index;

		// If clicking same star and half is allowed, toggle between half and full
		if (AllowHalf && Math.Abs(Value - index) < 0.01)
		{
			newValue = index - 0.5;
		}
		else if (AllowHalf && Math.Abs(Value - (index - 0.5)) < 0.01)
		{
			newValue = 0; // Clear if clicking on half-filled star
		}

		Value = newValue;
		await OnValueChanged.InvokeAsync(newValue);
	}

	private void HandleHover(int index)
	{
		if (Readonly)
		{
			return;
		}

		_isHovering = true;
		_hoverValue = index;
	}

	private void HandleMouseOut()
	{
		_isHovering = false;
	}

	private async Task HandleKeyDown(KeyboardEventArgs e)
	{
		if (Readonly)
		{
			return;
		}

		var step = AllowHalf ? 0.5 : 1.0;
		var newValue = Value;

		switch (e.Key)
		{
			case "ArrowRight":
			case "ArrowUp":
				newValue = Math.Min(MaxValue, Value + step);
				break;
			case "ArrowLeft":
			case "ArrowDown":
				newValue = Math.Max(0, Value - step);
				break;
			case "Home":
				newValue = 0;
				break;
			case "End":
				newValue = MaxValue;
				break;
		}

		if (Math.Abs(newValue - Value) > 0.01)
		{
			Value = newValue;
			await OnValueChanged.InvokeAsync(newValue);
		}
	}

	private string GetAriaLabel()
	{
		var label = $"Rating: {Value} out of {MaxValue}";
		if (Count.HasValue)
		{
			label += $" based on {Count.Value} reviews";
		}

		return label;
	}
}
